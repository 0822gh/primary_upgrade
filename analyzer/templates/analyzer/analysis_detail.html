{% extends 'analyzer/base.html' %}

{% block title %}{{ analysis.file_name }} - ë¶„ì„ ê²°ê³¼{% endblock %}

{% block content %}

<style>
  code.small { font-size: .85rem; }
  .text-wrap { white-space: normal !important; word-break: break-all; }
  .chip-row { display:flex; flex-wrap:wrap; gap:.4rem .5rem; }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2><i class="fas fa-mobile-alt me-2"></i>{{ analysis.file_name }}</h2>
  <div>
    <a href="{% url 'analyzer:analysis_list' %}" class="btn btn-outline-secondary me-2">
      <i class="fas fa-arrow-left me-1"></i>ëª©ë¡ìœ¼ë¡œ
    </a>
    <span class="badge 
      {% if analysis.status == 'completed' %}bg-success
      {% elif analysis.status == 'analyzing' %}bg-warning
      {% elif analysis.status == 'failed' %}bg-danger
      {% else %}bg-secondary{% endif %} fs-6">
      {{ analysis.get_status_display }}
    </span>
  </div>
</div>

{% if analysis.status == 'completed' %}

<!-- ================= ê¸°ë³¸ ì •ë³´ ================= -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>ê¸°ë³¸ ì •ë³´</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <table class="table table-borderless">
          <tr><td class="fw-bold">íŒŒì¼ëª…</td><td>{{ analysis.file_name }}</td></tr>
          <tr><td class="fw-bold">íŒŒì¼ í¬ê¸°</td><td>{{ analysis.file_size|filesizeformat }}</td></tr>
          <tr><td class="fw-bold">íŒ¨í‚¤ì§€ëª…</td><td><code>{{ analysis.package_name|default:"-" }}</code></td></tr>
          <tr><td class="fw-bold">ë²„ì „ëª…</td><td>{{ analysis.version_name|default:"-" }}</td></tr>
        </table>
      </div>
      <div class="col-md-6">
        <table class="table table-borderless">
          <tr><td class="fw-bold">ë²„ì „ ì½”ë“œ</td><td>{{ analysis.version_code|default:"-" }}</td></tr>
          <tr><td class="fw-bold">ìµœì†Œ SDK</td><td>{{ analysis.min_sdk|default:"-" }}</td></tr>
          <tr><td class="fw-bold">íƒ€ê²Ÿ SDK</td><td>{{ analysis.target_sdk|default:"-" }}</td></tr>
          <tr><td class="fw-bold">ë¶„ì„ ì‹œê°„</td><td>{{ analysis.analysis_time|date:"Y-m-d H:i:s" }}</td></tr>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ================= ì²˜ë¦¬ë°©ì¹¨ ë¼ë²¨ ================= -->
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between">
    <h5 class="mb-0"><i class="fas fa-tags me-2"></i>ì²˜ë¦¬ë°©ì¹¨ ë¼ë²¨</h5>
    <span class="badge bg-secondary">{{ analysis.policy_labels|length }}</span>
  </div>
  <div class="card-body">
    {% if analysis.policy_labels %}
      <div class="chip-row">
        {% for lbl in analysis.policy_labels %}
          <span class="badge bg-info text-dark fs-6"
                data-bs-toggle="tooltip"
                title="{{ lbl }}">{{ lbl }}</span>
        {% endfor %}
      </div>
    {% else %}
      <span class="text-muted">ì˜ˆì¸¡ ë¼ë²¨ ì—†ìŒ</span>
    {% endif %}
  </div>
</div>

<!-- ================= í¼ë¯¸ì…˜ ê¸°ë°˜ ë¼ë²¨ ================= -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between">
    <h5 class="mb-0"><i class="fas fa-key me-2"></i>í¼ë¯¸ì…˜ ê¸°ë°˜ ë¼ë²¨</h5>
    <span class="badge bg-secondary">{{ perm_labels_set|length }}</span>
  </div>
  <div class="card-body">
    {% if perm_labels_set %}
      <div class="chip-row">
        {% for lbl in perm_labels_set %}
          <span class="badge bg-warning text-dark fs-6">{{ lbl }}</span>
        {% endfor %}
      </div>
    {% else %}
      <span class="text-muted">ìœ ë„ëœ ë¼ë²¨ ì—†ìŒ</span>
    {% endif %}
  </div>
</div>

<!-- ================= ë¼ë²¨ ì¼ì¹˜ì„± ìš”ì•½ ================= -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="fas fa-search me-2"></i>ë¼ë²¨ ì¼ì¹˜ì„± ì ê²€</h5>
  </div>
  <div class="card-body">

    {% if missing_in_policy %}
      <div class="alert alert-danger d-flex align-items-center">
        <span class="badge bg-danger me-2">ëˆ„ë½</span>
        {% for lb in missing_in_policy %}
          <span class="badge bg-light text-danger border me-1">{{ lb }}</span>
        {% endfor %}
      </div>
    {% endif %}

    {% if extra_in_policy %}
      <div class="alert alert-warning d-flex align-items-center">
        <span class="badge bg-warning text-dark me-2">ê³¼ê¸°ì¬</span>
        {% for lb in extra_in_policy %}
          <span class="badge bg-light text-warning border me-1">{{ lb }}</span>
        {% endfor %}
      </div>
    {% endif %}

    {% if not missing_in_policy and not extra_in_policy %}
      <div class="alert alert-success">
        <i class="fas fa-check-circle me-2"></i>ì²˜ë¦¬ë°©ì¹¨ê³¼ ì•± ê¶Œí•œì´ ëŒ€ì²´ë¡œ ì¼ì¹˜í•©ë‹ˆë‹¤.
      </div>
    {% endif %}
  </div>
</div>

<!-- ================= ğŸ”¥ ë¼ë²¨ ê¸°ë°˜ ê²€í†  ìš”ì•½ (ê°€ë…ì„± ê°œì„  í•µì‹¬) ================= -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between">
    <h5 class="mb-0">
      <i class="fas fa-clipboard-check me-2"></i>ë¼ë²¨ ê¸°ë°˜ ê²€í†  ìš”ì•½
    </h5>
    <span class="badge bg-secondary">{{ review_sentences|length }}</span>
  </div>

  <div class="card-body">
    {% if review_sentences %}
      <div class="vstack gap-2">
        {% for item in review_sentences %}
        <div class="border rounded p-3">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex gap-2 align-items-center">
              {% if item.tag == "ëˆ„ë½" %}
                <span class="badge bg-danger">ëˆ„ë½</span>
              {% elif item.tag == "ê³¼ê¸°ì¬" %}
                <span class="badge bg-warning text-dark">ê³¼ê¸°ì¬</span>
              {% else %}
                <span class="badge bg-success">ì¼ì¹˜</span>
              {% endif %}
              <span class="badge bg-dark">{{ item.label }}</span>
            </div>

            <button class="btn btn-sm btn-outline-secondary"
                    data-bs-toggle="collapse"
                    data-bs-target="#rev{{ forloop.counter }}">
              ìì„¸íˆ
            </button>
          </div>

          <div class="text-muted small mt-2">
            {% if item.tag == "ëˆ„ë½" %}
              ì•± êµ¬í˜„ ëŒ€ë¹„ ì²˜ë¦¬ë°©ì¹¨ ê³ ì§€ ëˆ„ë½ ê°€ëŠ¥ì„±
            {% elif item.tag == "ê³¼ê¸°ì¬" %}
              ì²˜ë¦¬ë°©ì¹¨ì— ê¸°ì¬ë˜ì–´ ìˆìœ¼ë‚˜ êµ¬í˜„ ê·¼ê±° ë¶€ì¡±
            {% else %}
              ì²˜ë¦¬ë°©ì¹¨ê³¼ êµ¬í˜„ ê°€ëŠ¥ì„±ì´ ëŒ€ì²´ë¡œ ì •í•©
            {% endif %}
          </div>

          <div class="collapse mt-2" id="rev{{ forloop.counter }}">
            <div style="line-height:1.6">{{ item.sentence }}</div>

            {% if item.evidence %}
            <div class="mt-2">
              <div class="small text-muted">ê·¼ê±° ê¶Œí•œ</div>
              <div class="d-flex flex-wrap gap-2">
                {% for p in item.evidence %}
                  <span class="badge bg-light border">
                    <code class="small">{{ p }}</code>
                  </span>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">ê²€í†  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>
</div>

{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
      new bootstrap.Tooltip(el);
    });
  });
</script>

{% endblock %}
